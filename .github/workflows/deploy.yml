name: Deploy Lawyer App to Alibaba Cloud ECS

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  APP_NAME: "lawyer-app"
  APP_DIR: "/home/apps/lawyer-app"
  BACKUP_ROOT: "/home/backups"
  TMP_DIR: "/home/tmp"
  NGINX_CONF_DIR: /etc/nginx
  ECS_HOST: ${{ secrets.ECS_HOST }}
  ECS_USERNAME: ${{ secrets.ECS_USERNAME }}

jobs:
  # 构建打包
  build-and-images:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 9
        run_install: false
        
    - name: Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'

    - name: Get pnpm store path
      id: pnpm-cache
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_OUTPUT
        
    - name: Setup pnpm cache
      uses: actions/cache@v3
      with:
        path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Setup Production Environment
      run: |
        cat <<EOF > projects/server-project/.env
        DATABASE_URL=${{ secrets.DATABASE_URL }}
        NODE_ENV=production
        SENTRY_AUTH_TOKEN=${{ secrets.SENTRY_AUTH_TOKEN }}
        SUPER_ROLE_EMAIL=${{ secrets.SUPER_ROLE_EMAIL }}
        SUPER_ROLE_PASSWORD=${{ secrets.SUPER_ROLE_PASSWORD }}
        SUPER_ROLE_NICKNAME=${{ secrets.SUPER_ROLE_NICKNAME }}
        QINIU_ACCESS_KEY=${{ secrets.QINIU_ACCESS_KEY }}
        QINIU_SECRET_KEY=${{ secrets.QINIU_SECRET_KEY }}
        EOF

        cat <<EOF > projects/web-project/.env
        SENTRY_AUTH_TOKEN=${{ secrets.SENTRY_AUTH_TOKEN }}
        WEBSITE_URL=${{ secrets.WEBSITE_URL }}
        SITE_DOMAIN=${{ secrets.SITE_DOMAIN }}
        EOF
        
    - name: Install dependencies
      run: pnpm install --prod --frozen-lockfile --ignore-scripts
      
    - name: Build projects
      run: pnpm build

    - name: Build Docker image
      run: |
        echo "=== 构建Docker镜像 ==="
        docker build -t lawyer-app:latest -f docker/Dockerfile .
        
        echo "=== 保存镜像 ==="
        docker save lawyer-app:latest -o app-image.tar

    - name: Create deployment directory
      run: |
        mkdir -p deployment
        # 复制构建产物
         rsync -av \
          --exclude='node_modules' \
          --exclude='.git' \
          --exclude='.next' \
          --exclude='dist' \
          --exclude='deployment' \
          --exclude='.env' \
          --exclude='.env.*' \
          --exclude='app-image.tar' \
          . deployment/

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: deployment
        retention-days: 1

    - name: Test Docker image
      run: |
        echo "=== 测试服务启动 ==="
        # 启动容器并测试服务
        docker run -d --name test-lawyer-app -p 3000:3000 -p 4000:4000 lawyer-app:latest
        
        echo "等待服务启动..."
        sleep 30
        
        echo "=== 健康检查 ==="
        # 检查后端服务
        if curl -s -f http://localhost:4000/health; then
          echo "✓ 后端服务启动成功"
        else
          echo "✗ 后端服务启动失败"
          docker logs test-lawyer-app
          docker stop test-lawyer-app
          docker rm test-lawyer-app
          exit 1
        fi
        
        # 检查前端服务
        if curl -s -f http://localhost:3000/api/health; then
          echo "✓ 前端服务启动成功"
        else
          echo "✗ 前端服务启动失败"
          docker logs test-lawyer-app
          docker stop test-lawyer-app
          docker rm test-lawyer-app
          exit 1
        fi
        
        echo "=== 停止并删除测试容器 ==="
        docker stop test-lawyer-app
        docker rm test-lawyer-app

        echo "=== 压缩发布文件 ==="
        mv app-image.tar deployment/app-image.tar
        tar -czvf deployment.tar.gz -C deployment .

    - name: Copy project to ECS
      uses: appleboy/scp-action@v0.1.3
      with:
        host: ${{ secrets.ECS_HOST }}
        username: ${{ secrets.ECS_USERNAME }}
        key: ${{ secrets.ECS_SSH_KEY }}
        source: "deployment.tar.gz"
        target: ${{ env.TMP_DIR }}
        
  deployment:
    needs: build-and-images
    runs-on: ubuntu-latest
    steps:
    - name: Execute deployment script
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ECS_HOST }}
        username: ${{ secrets.ECS_USERNAME }}
        key: ${{ secrets.ECS_SSH_KEY }}
        script: |
          echo "=== 开始部署 ==="
          echo "部署时间: $(date)"
          echo "提交: ${{ github.sha }}"
          echo "分支: ${{ github.ref }}"

          # 备份当前应用，仅保留最近3份
          if [ -d "${{ env.BACKUP_ROOT }}" ]; then
            TIMESTAMP=$(date +"%Y%m%d%H%M%S")
            BACKUP_DIR="${{ env.BACKUP_ROOT }}/${{ env.APP_NAME }}_$TIMESTAMP"
            mkdir -p ${{ env.BACKUP_ROOT }}
            echo "备份当前应用到 $BACKUP_DIR"
            mv ${{ env.APP_DIR }} "$BACKUP_DIR"
            # 清理旧备份，仅保留最近3份
            ls -dt ${{ env.BACKUP_ROOT }}/${{ env.APP_NAME }}_* | tail -n +4 | xargs -r rm -rf
          else
            echo "没有找到现有应用目录，跳过备份步骤"
          fi

          # 删除旧的应用目录（如果存在）
          sudo rm -rf ${{ env.APP_DIR }}

          # 创建新的应用目录
          mkdir -p ${{ env.APP_DIR }}

          # 解压传输的文件
          if [ -f "${{ env.TMP_DIR }}/deployment.tar.gz" ]; then
            tar -xzvf ${{ env.TMP_DIR }}/deployment.tar.gz -C ${{ env.APP_DIR }}
          else
            echo "❌ 未找到部署包: ${{ env.TMP_DIR }}/deployment.tar.gz"
            # 还原备份
            if [ -d "$BACKUP_DIR" ]; then
              mv "$BACKUP_DIR" ${{ env.APP_DIR }}
              echo "已还原备份到 ${{ env.APP_DIR }}"
            fi
            exit 1
          fi

          # 删除tmp目录
          rm -rf ${{ env.TMP_DIR }}

          # 创建SSL证书目录并写入证书
          sudo mkdir -p ${{ env.NGINX_CONF_DIR }}/ssl
          echo "${{ secrets.SSL_CERT }}" | sudo tee ${{ env.NGINX_CONF_DIR }}/ssl/${{ env.APP_NAME }}.crt > /dev/null
          echo "${{ secrets.SSL_KEY }}" | sudo tee ${{ env.NGINX_CONF_DIR }}/ssl/${{ env.APP_NAME }}.key > /dev/null
          sudo chmod 600 ${{ env.NGINX_CONF_DIR }}/ssl/${{ env.APP_NAME }}.*
          echo "SSL证书已配置"
          
          echo "=== 复制Nginx配置文件 ==="
          sudo mkdir -p ${{ env.NGINX_CONF_DIR }}/conf.d
          cat <<EOF > ${{ env.NGINX_CONF_DIR }}/conf.d/${{ env.APP_NAME }}.conf
          # HTTP重定向到HTTPS
          # server {
          #     listen 80;
          #     server_name ${{ secrets.SITE_DOMAIN }} www.${{ secrets.SITE_DOMAIN }};
          #     return 301 https://$server_name$request_uri;
          # }

          server {
              listen 80;
              server_name ${{ secrets.SITE_DOMAIN }} www.${{ secrets.SITE_DOMAIN }};
              # listen 443 ssl;
              # http2 on;
              # server_name ${{ secrets.SITE_DOMAIN }} www.${{ secrets.SITE_DOMAIN }};

              # SSL证书配置
              # ssl_certificate /etc/nginx/ssl/lawyer-app.crt;
              # ssl_certificate_key /etc/nginx/ssl/lawyer-app.key;
              # ssl_protocols TLSv1.2 TLSv1.3;
              # ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
              # ssl_prefer_server_ciphers off;
              
              # 安全头
              add_header X-Frame-Options DENY;
              add_header X-Content-Type-Options nosniff;
              add_header X-XSS-Protection "1; mode=block";
              add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload";

              # 文件大小限制
              client_max_body_size 10m;

              # Gzip压缩配置
              gzip on;
              gzip_vary on;
              gzip_min_length 1024;
              gzip_types
                  text/plain
                  text/css
                  text/xml
                  text/javascript
                  application/javascript
                  application/xml+rss
                  application/json;

              # ==================== 静态资源缓存配置 ====================

              # Next.js _next 静态资源 - 最长缓存
              location ~* ^/_next/static/ {
                  expires 1y;
                  add_header Cache-Control "public, immutable, max-age=31536000";
                  proxy_pass http://frontend_servers;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  
                  # 针对2核4G服务器优化
                  proxy_buffering on;
                  proxy_buffer_size 4k;
                  proxy_buffers 8 4k;
              }

              # Next.js 图片等静态资源
              location ~* \.(jpg|jpeg|png|gif|ico|svg|webp)$ {
                  expires 6M;
                  add_header Cache-Control "public, immutable";
                  proxy_pass http://frontend_servers;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }

              # CSS/JS 字体文件
              location ~* \.(css|js|woff|woff2|ttf|eot)$ {
                  expires 1y;
                  add_header Cache-Control "public, immutable";
                  proxy_pass http://frontend_servers;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }

              # ==================== API 路由配置 ====================

              # 前端Next.js API路由 (www.myapp.com/api)
              location /api/ {
                  # 转发到前端服务（Next.js API Routes）
                  proxy_pass http://frontend_servers/api/;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  
                  # 超时配置优化（针对2核4G）
                  proxy_connect_timeout 15s;
                  proxy_send_timeout 30s;
                  proxy_read_timeout 30s;
                  
                  # 零停机部署支持
                  proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
                  proxy_next_upstream_timeout 5s;
                  proxy_next_upstream_tries 2;
                  
                  # 禁用缓冲以便实时响应
                  proxy_buffering off;
              }

              # 后端Express RESTful API (www.myapp.com/restful/)
              location /restful/ {
                  proxy_pass http://backend_servers/restful/;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_set_header X-Forwarded-Prefix /restful;
                  
                  # 超时配置
                  proxy_connect_timeout 15s;
                  proxy_send_timeout 30s;
                  proxy_read_timeout 30s;
                  
                  # 零停机部署支持
                  proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
                  proxy_next_upstream_timeout 5s;
                  proxy_next_upstream_tries 2;
                  
                  # 对于API请求，禁用缓冲以获得实时响应
                  proxy_buffering off;
              }

              # ==================== 健康检查端点 ====================

              # Nginx自身健康检查
              location /health {
                  access_log off;
                  return 200 "healthy\n";
                  add_header Content-Type text/plain;
              }

              # 前端健康检查
              location /api/health {
                  proxy_pass http://frontend_servers/api/health;
                  access_log off;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_buffering off;
              }

              # 后端健康检查
              location /restful/health {
                  proxy_pass http://backend_servers/health;
                  access_log off;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_buffering off;
              }

              # ==================== 前端路由配置 ====================

              # 所有其他请求都转发到Next.js前端
              location / {
                  proxy_pass http://frontend_servers;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_set_header X-Forwarded-Host $host;
                  proxy_set_header X-Forwarded-Port $server_port;
                  
                  # 超时配置
                  proxy_connect_timeout 15s;
                  proxy_send_timeout 30s;
                  proxy_read_timeout 30s;
                  
                  # 缓冲优化
                  proxy_buffering on;
                  proxy_buffer_size 4k;
                  proxy_buffers 8 4k;
                  proxy_busy_buffers_size 8k;
              }

              # ==================== 安全配置 ====================

              # 禁止访问敏感文件
              location ~ /\. {
                  deny all;
                  access_log off;
                  log_not_found off;
              }
              
              location ~ /\_ {
                  deny all;
                  access_log off;
                  log_not_found off;
              }

              # 隐藏版本信息
              server_tokens off;
          }
          
          # 执行部署脚本
          echo "=== 运行数据库迁移脚本 ==="
          cd ${{ env.APP_DIR }}
          pnpm db:migrate

          chmod +x ${{ env.APP_DIR }}/scripts/deploy.sh
          ${{ env.APP_DIR }}/scripts/deploy.sh
          
          echo "=== 部署完成 ==="
          echo "Nginx状态:"
          systemctl status nginx --no-pager -l
          echo "服务状态:"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

  # 健康检查（部署后）
  health-check:
    needs: deployment
    runs-on: ubuntu-latest
    
    steps:
    - name: Check service health
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ECS_HOST }}
        username: ${{ secrets.ECS_USERNAME }}
        key: ${{ secrets.ECS_SSH_KEY }}
        script: |
          echo "=== 最终健康检查 ==="
          chmod +x ${{ env.APP_DIR }}/scripts/health-check.sh
          ${{ env.APP_DIR }}/scripts/health-check.sh