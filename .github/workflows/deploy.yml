name: Deploy Lawyer App to Alibaba Cloud ECS

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  APP_NAME: "lawyer-app"
  APP_DIR: "/home/apps/lawyer-app"
  NGINX_CONF_DIR: /etc/nginx
  ECS_HOST: ${{ secrets.ECS_HOST }}
  ECS_USERNAME: ${{ secrets.ECS_USERNAME }}

jobs:
  # 构建打包
  build-and-package:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 9
        
    - name: Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        
    - name: Install dependencies
      run: pnpm install
      
    - name: Build projects
      run: pnpm -r build
      
    - name: Create deployment directory
      run: |
        mkdir -p deployment
        # 复制整个工程（包括node_modules和构建产物）
        rsync -av --exclude='deployment' . deployment/ || true
        # 创建SSL证书目录
        mkdir -p deployment/nginx/ssl
        # 确保包含所有必要文件
        ls -la deployment/projects/web-project/.next/ || echo "Next.js构建目录不存在"
        ls -la deployment/projects/server-project/dist/ || echo "后端构建目录不存在"
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: deployment
        retention-days: 1
  
  # 构建Docker镜像
  build-docker-images:
    needs: build-and-package
    runs-on: ubuntu-latest
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: deployment
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build frontend image
      run: |
        cd deployment
        docker build -t lawyer-frontend:latest -f docker/frontend.Dockerfile .
        docker save lawyer-frontend:latest -o frontend-image.tar
        
    - name: Build backend image
      run: |
        cd deployment
        docker build -t lawyer-backend:latest -f docker/backend.Dockerfile .
        docker save lawyer-backend:latest -o backend-image.tar
        
    - name: Upload docker images artifacts
      uses: actions/upload-artifact@v4
      with:
        name: docker-images
        path: |
          deployment/frontend-image.tar
          deployment/backend-image.tar
        retention-days: 1
  
  # 部署到生产环境
  deploy-production:
    needs: build-docker-images
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: deployment
        
    - name: Copy project to ECS
      uses: appleboy/scp-action@v0.1.3
      with:
        host: ${{ secrets.ECS_HOST }}
        username: ${{ secrets.ECS_USERNAME }}
        key: ${{ secrets.ECS_SSH_KEY }}
        source: "deployment/*"
        target: ${{ env.APP_DIR }}
        strip_components: 1
        
    - name: Execute deployment script
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ECS_HOST }}
        username: ${{ secrets.ECS_USERNAME }}
        key: ${{ secrets.ECS_SSH_KEY }}
        script: |
          echo "=== 开始部署 ==="
          echo "部署时间: $(date)"
          echo "提交: ${{ github.sha }}"
          echo "分支: ${{ github.ref }}"

          echo "=== 复制Nginx配置文件和SSL证书 ==="
          sudo mkdir -p $NGINX_CONF_DIR/conf.d
          cp -r $APP_DIR/nginx/conf.d/*.conf $NGINX_CONF_DIR/conf.d/
          # 创建SSL证书目录（如果不存在）
          sudo mkdir -p ${{ env.NGINX_CONF_DIR }}/ssl
          # 写入证书文件
          echo "${{ secrets.SSL_CERT }}" | sudo tee ${{ env.NGINX_CONF_DIR }}/ssl/${{ env.APP_NAME }}.crt > /dev/null
          echo "${{ secrets.SSL_KEY }}" | sudo tee ${{ env.NGINX_CONF_DIR }}/ssl/${{ env.APP_NAME }}.key > /dev/null
          echo "Nginx配置文件已更新"
          
          # 执行部署脚本
          chmod +x $APP_DIR/scripts/deploy.sh
          $APP_DIR/scripts/deploy.sh
          
          echo "=== 部署完成 ==="
          echo "Nginx状态:"
          systemctl status nginx --no-pager -l
          echo "服务状态:"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

  # 健康检查（部署后）
  health-check:
    needs: deploy-production
    runs-on: ubuntu-latest
    
    steps:
    - name: Check service health
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ECS_HOST }}
        username: ${{ secrets.ECS_USERNAME }}
        key: ${{ secrets.ECS_SSH_KEY }}
        script: |
          echo "=== 最终健康检查 ==="
          chmod +x $APP_DIR/scripts/health-check.sh
          $APP_DIR/scripts/health-check.sh
          
          echo "=== 服务状态 ==="
          docker-compose ps
          
          echo "=== 最近日志 ==="
          docker logs lawyer-frontend --tail 20 2>/dev/null || echo "前端容器日志不可用"
          docker logs lawyer-backend --tail 20 2>/dev/null || echo "后端容器日志不可用"