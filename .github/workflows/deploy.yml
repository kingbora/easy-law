name: Deploy Lawyer App to Alibaba Cloud ECS

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  APP_NAME: "lawyer-app"
  APP_DIR: "/home/apps/lawyer-app"
  BACKUP_ROOT: "/home/backups"
  TMP_DIR: "/home/tmp"
  NGINX_CONF_DIR: /etc/nginx
  ECS_HOST: ${{ secrets.ECS_HOST }}
  ECS_USERNAME: ${{ secrets.ECS_USERNAME }}

jobs:
  # 构建打包
  build-and-images:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 9
        run_install: false
        
    - name: Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'

    - name: Get pnpm store path
      id: pnpm-cache
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_OUTPUT
        
    - name: Setup pnpm cache
      uses: actions/cache@v3
      with:
        path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
        
    - name: Install dependencies
      run: pnpm install --prod --frozen-lockfile --ignore-scripts
      
    - name: Build projects
      run: pnpm build

    - name: Build and test image
      run: |
        mkdir -p deployment
        # 复制构建产物
        rsync -av \
          --exclude='node_modules' \
          --exclude='.git' \
          --exclude='.next' \
          --exclude='dist' \
          --exclude='deployment' \
          . deployment/

    - name: Upload build and image artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: deployment
        retention-days: 1

    - name: Test Docker image
      run: |
        echo "=== 当前目录结构 ==="
        ls -la
        echo "=== 构建Docker镜像 ==="
        docker build -t lawyer-app:latest -f docker/Dockerfile .
        
        echo "=== 保存镜像 ==="
        docker save lawyer-app:latest -o deployment/app-image.tar

        tar -czvf deployment.tar.gz -C deployment .
        
        echo "=== 测试服务启动 ==="
        # 启动容器并测试服务
        docker run -d --name test-lawyer-app -p 3000:3000 -p 4000:4000 -e DATABASE_URL="${{ secrets.DATABASE_URL }}" lawyer-app:latest
        
        echo "等待服务启动..."
        sleep 30
        
        echo "=== 健康检查 ==="
        # 检查后端服务
        if curl -s -f http://localhost:4000/health; then
          echo "✓ 后端服务启动成功"
        else
          echo "✗ 后端服务启动失败"
          docker logs test-lawyer-app
          docker stop test-lawyer-app
          docker rm test-lawyer-app
          exit 1
        fi
        
        # 检查前端服务
        if curl -s -f http://localhost:3000/api/health; then
          echo "✓ 前端服务启动成功"
        else
          echo "✗ 前端服务启动失败"
          docker logs test-lawyer-app
          docker stop test-lawyer-app
          docker rm test-lawyer-app
          exit 1
        fi
        
        echo "=== 停止并删除测试容器 ==="
        docker stop test-lawyer-app
        docker rm test-lawyer-app

    - name: Copy project to ECS
      uses: appleboy/scp-action@v0.1.3
      with:
        host: ${{ secrets.ECS_HOST }}
        username: ${{ secrets.ECS_USERNAME }}
        key: ${{ secrets.ECS_SSH_KEY }}
        source: "deployment.tar.gz"
        target: ${{ env.TMP_DIR }}
        strip_components: 1
        
  deployment:
    needs: build-and-images
    runs-on: ubuntu-latest
    steps:
    - name: Setup environment variables
      run: |
        echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> $GITHUB_ENV
        echo "SENTRY_AUTH_TOKEN=${{ secrets.SENTRY_AUTH_TOKEN }}" >> $GITHUB_ENV
        echo "SUPER_ROLE_EMAIL=${{ secrets.SUPER_ROLE_EMAIL }}" >> $GITHUB_ENV
        echo "SUPER_ROLE_PASSWORD=${{ secrets.SUPER_ROLE_PASSWORD }}" >> $GITHUB_ENV
        echo "SUPER_ROLE_NICKNAME=${{ secrets.SUPER_ROLE_NICKNAME }}" >> $GITHUB_ENV
        echo "QINIU_ACCESS_KEY=${{ secrets.QINIU_ACCESS_KEY }}" >> $GITHUB_ENV
        echo "QINIU_SECRET_KEY=${{ secrets.QINIU_SECRET_KEY }}" >> $GITHUB_ENV

    - name: Execute deployment script
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ECS_HOST }}
        username: ${{ secrets.ECS_USERNAME }}
        key: ${{ secrets.ECS_SSH_KEY }}
        script: |
          echo "=== 开始部署 ==="
          echo "部署时间: $(date)"
          echo "提交: ${{ github.sha }}"
          echo "分支: ${{ github.ref }}"

          # 备份当前应用，仅保留最近3份
          if [ -d "${{ env.BACKUP_ROOT }}" ]; then
            TIMESTAMP=$(date +"%Y%m%d%H%M%S")
            BACKUP_DIR="${{ env.BACKUP_ROOT }}/${{ env.APP_NAME }}_$TIMESTAMP"
            mkdir -p ${{ env.BACKUP_ROOT }}
            echo "备份当前应用到 $BACKUP_DIR"
            mv ${{ env.APP_DIR }} "$BACKUP_DIR"
            # 清理旧备份，仅保留最近3份
            ls -dt ${{ env.BACKUP_ROOT }}/${{ env.APP_NAME }}_* | tail -n +4 | xargs -r rm -rf
          else
            echo "没有找到现有应用目录，跳过备份步骤"
          fi

          # 删除旧的应用目录（如果存在）
          sudo rm -rf ${{ env.APP_DIR }}

          # 创建新的应用目录
          mkdir -p ${{ env.APP_DIR }}

          # 解压传输的文件
          if [ -f "${{ env.TMP_DIR }}/deployment.tar.gz" ]; then
            tar -xzvf ${{ env.TMP_DIR }}/deployment.tar.gz -C ${{ env.APP_DIR }}
          else
            echo "❌ 未找到部署包: ${{ env.TMP_DIR }}/deployment.tar.gz"
            # 还原备份
            if [ -d "$BACKUP_DIR" ]; then
              mv "$BACKUP_DIR" ${{ env.APP_DIR }}
              echo "已还原备份到 ${{ env.APP_DIR }}"
            fi
            exit 1
          fi

          # 删除tmp目录
          rm -rf ${{ env.TMP_DIR }}
          
          echo "=== 复制Nginx配置文件 ==="
          sudo mkdir -p ${{ env.NGINX_CONF_DIR }}/conf.d
          sudo cp -f ${{ env.APP_DIR }}/nginx/conf.d/*.conf ${{ env.NGINX_CONF_DIR }}/conf.d/ || echo "Nginx配置文件复制完成"
          
          # 创建SSL证书目录并写入证书
          sudo mkdir -p ${{ env.NGINX_CONF_DIR }}/ssl
          echo "${{ secrets.SSL_CERT }}" | sudo tee ${{ env.NGINX_CONF_DIR }}/ssl/${{ env.APP_NAME }}.crt > /dev/null
          echo "${{ secrets.SSL_KEY }}" | sudo tee ${{ env.NGINX_CONF_DIR }}/ssl/${{ env.APP_NAME }}.key > /dev/null
          sudo chmod 600 ${{ env.NGINX_CONF_DIR }}/ssl/${{ env.APP_NAME }}.*
          echo "SSL证书已配置"
          
          # 执行部署脚本
          pnpm db:migrate

          chmod +x ${{ env.APP_DIR }}/scripts/deploy.sh
          ${{ env.APP_DIR }}/scripts/deploy.sh
          
          echo "=== 部署完成 ==="
          echo "Nginx状态:"
          systemctl status nginx --no-pager -l
          echo "服务状态:"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

  # 健康检查（部署后）
  health-check:
    needs: deployment
    runs-on: ubuntu-latest
    
    steps:
    - name: Check service health
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ECS_HOST }}
        username: ${{ secrets.ECS_USERNAME }}
        key: ${{ secrets.ECS_SSH_KEY }}
        script: |
          echo "=== 最终健康检查 ==="
          chmod +x ${{ env.APP_DIR }}/scripts/health-check.sh
          ${{ env.APP_DIR }}/scripts/health-check.sh